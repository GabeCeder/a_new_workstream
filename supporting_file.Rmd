---
title: "supporting_file"
author: "Gabe Cederberg"
date: "2/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading the important packages.

library(tidyverse)
library(readr)
library(janitor)
library(ggthemes)
library(viridis)  
library(tidycensus)
library(transformr)
library(lubridate)
library(RColorBrewer)
library(scales)
library(tmaptools)
library(patchwork)
library(RCurl)
library(readxl)
library(zoo)
library(sf)

# Turn off scientific notation

options(scipen = 999)

# Cache shapefiles for use in future sessions

options(tigris_use_cache = TRUE)

```

```{r}
end_date <- "2021-02-12"
theme2 <- theme(plot.title = element_blank(),
        legend.title = element_blank(),
        legend.text = element_blank(),
        legend.position = "right",
        legend.key.width = unit(0.5, "cm"))
```

```{r}
# Load county data

county_pop <- get_acs(geography = "county",
                  variables = c(pop = "B01003_001"), 
                  year = 2018,
                  geometry = TRUE, 
                  shift_geo = TRUE) %>% 
  clean_names() %>% 
   select(
     #geoid, 
          name, 
          "pop" = estimate,
          geometry) %>% 
  separate(col = name, c("county", "state"), sep = ", ") %>% 
  mutate(county = str_remove_all(county, " County")) %>% 
  mutate(county = str_remove_all(county, " Parish")) 

county_pop_num <- county_pop %>% 
  select(state, county, pop)
```


```{r}
# Case and death data

state_text <- getURL("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")
state <- read_csv(state_text) %>% 
  group_by(state) %>% 
  mutate(new_cases = cases - lag(cases, k = 1)) %>% 
  mutate(new_cases = case_when(new_cases < 0 ~ 0,
                               new_cases >= 0 ~ new_cases)) %>% 
  mutate(cases_7day_avg =  rollapply(new_cases, 7, mean, fill = NA, align = 'right')) %>% 
  mutate(delta_cases_WoW = 100 * (0 - (1 - (cases_7day_avg / lag(cases_7day_avg, 7, default = 0, order_by = date))))) %>% 
  mutate(new_deaths = deaths - lag(deaths, k = 1)) %>% 
  mutate(new_deaths = case_when(new_deaths < 0 ~ 0,
                               new_deaths >= 0 ~ new_deaths)) %>% 
  mutate(deaths_7day_avg =  rollapply(new_deaths, 7, mean, fill = NA, align = 'right')) %>% 
  mutate(delta_deaths_WoW = 100 * (0 - (1 - (deaths_7day_avg / lag(deaths_7day_avg, 7, default = 0, order_by = date))))) %>% 
  slice_max(order_by = date, n = 1) %>% 
  select(date,
         state, 
         "today_cases_7day_avg" = cases_7day_avg,
         delta_cases_WoW,
         "cumulative_cases" = cases,
         "today_deaths_7day_avg" = deaths_7day_avg,
         delta_deaths_WoW,
         "cumulative_deaths" = deaths)

# State geography and population

state_pop <- get_acs(geography = "state",
                  variables = c(pop = "B01003_001"), 
                  year = 2018,
                  geometry = TRUE,
                  shift_geo = TRUE) %>% 
  clean_names() %>% 
   select(geoid, 
          "state" = name, 
        #  "pop" = estimate,
          "state_geometry" = geometry)  


# State abbreviations

# c <- read_excel("data/state_abbreviations.xlsx")

# Vaccines data

vaccines_text <- getURL("https://raw.githubusercontent.com/youyanggu/covid19-cdc-vaccination-data/main/aggregated_adjusted.csv")
vaccines <- read_csv(vaccines_text) %>% 
  clean_names() %>% 
  select(date, 
         "pop" = census2019,
         "state" = long_name,
         "cumulative_doses_administered" = doses_administered,
         "today_seven_day_avg_doses_adm" = doses_administered_daily_7day_avg,
     #    "daily_doses_administered" = doses_distributed_daily
         ) %>% 
  filter(!(state %in% c("American Samoa",
                        "Bureau of Prisons",
                        "Dept of Defense",
                        "Federated States of Micronesia",
                        "Guam",
                        "Indian Health Svc",
                        "Long Term Care",
                        "Marshall Islands",
                        "Northern Mariana Islands",
                        "Puerto Rico",
                        "Republic of Palau",
                        "Veterans Health",
                        "Virgin Islands",
                        "United States"))) %>% 
  group_by(state) %>% 
  mutate(delta_doses_WoW = 100 * (0 - (1 - (today_seven_day_avg_doses_adm / 
                                                 lag(today_seven_day_avg_doses_adm, 7, default = 0, order_by = date))))) %>% 
  slice_max(order_by = date, n = 1) %>% 
  mutate(state = case_when(state == "New York State" ~ "New York",
                           state != "New York State" ~ state))

pop <- vaccines %>% 
  select(state, pop)
```

```{r}
a <- vaccines %>% 
  select(-pop) %>% 
  left_join(state, by = "state") 

b <- a %>% select(-date.x, -date.y) %>% pivot_longer(!state, names_to = "view", values_to = "number")

c <- b %>% 
  left_join(pop, by = "state") %>% 
  mutate(per_100K_number = case_when(view %in% c("delta_doses_WoW",
                                               "delta_cases_WoW",
                                               "delta_deaths_WoW") ~ number, 
                                     !(view %in% c("delta_doses_WoW",
                                               "delta_cases_WoW",
                                               "delta_deaths_WoW")) ~ number / pop * 100000)) %>% 
  select(-pop)

c$number <- round(c$number, 2)
c$per_100K_number <- round(c$per_100K_number, 2)

d <- c %>% 
  mutate(slice1 = case_when(grepl("doses", view) ~ "vax",
                           grepl("cases", view) ~ "cases",
                           grepl("deaths", view) ~ "deaths",
                           grepl("hosp", view) ~ "hosp")) %>% 
  mutate(slice2 = case_when(grepl("today", view) ~ "today",
                            grepl("WoW", view) ~ "WoW",
                            grepl("cumulative", view) ~ "cumulative")) %>% 
  mutate(viz_number = comma(number),
         viz_per_100K_number = comma(per_100K_number)) %>% 
  separate(viz_number, c("viz_number"), "\\.") %>% 
  separate(viz_per_100K_number, c("viz_per_100K_number"), "\\.") %>% 
  mutate(viz_number = case_when(slice2 == "WoW" ~ paste(viz_number, "%", sep = ""),
                            slice2 != "WoW" ~ viz_number),
         viz_per_100K_number = case_when((slice2 == "WoW" ~ paste(viz_per_100K_number, "%", sep = "")),
                                          slice2 != "WoW" ~ viz_per_100K_number)) %>% 
  mutate(viz_number = case_when(slice2 == "WoW" & number > 0 ~ paste("+", viz_number, sep = ""),
                                slice2 != "WoW" | number <= 0 ~ viz_number),
         viz_per_100K_number = case_when(slice2 == "WoW" & per_100K_number > 0 ~ paste("+", viz_per_100K_number, sep = ""),
                                         slice2 != "Wow" | per_100K_number <= 0 ~ viz_per_100K_number))

d

```
```{r}
#b <- state_pop %>% 
#  right_join(a, by = c("state_name" = "state"))

```

```{r}

saveRDS(d, file = paste("analysis_app/data_files/map_data", end_date, ".rds", sep = ""))

```

```{r}
saveRDS(state_pop, file = "analysis_app/data_files/geo_data.rds")
```


```{r}
county_text <- getURL("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")
county <- read_csv(county_text)

county$county <- gsub("DoÃ±a Ana", "Doña Ana", county$county)

ff <- county %>% 
  group_by(state, county) %>% 
  mutate(new_cases = cases - lag(cases, k = 1)) %>% 
  mutate(new_cases = case_when(new_cases < 0 ~ 0,
                               new_cases >= 0 ~ new_cases)) %>% 
  mutate(cases_7day_avg =  rollapply(new_cases, 7, mean, fill = NA, align = 'right')) %>% 
  mutate(delta_cases_WoW = 100 * (0 - (1 - (cases_7day_avg / lag(cases_7day_avg, 7, default = 0, order_by = date))))) %>% 
  mutate(new_deaths = deaths - lag(deaths, k = 1)) %>% 
  mutate(new_deaths = case_when(new_deaths < 0 ~ 0,
                               new_deaths >= 0 ~ new_deaths)) %>% 
  mutate(deaths_7day_avg =  rollapply(new_deaths, 7, mean, fill = NA, align = 'right')) %>% 
  mutate(delta_deaths_WoW = 100 * (0 - (1 - (deaths_7day_avg / lag(deaths_7day_avg, 7, default = 0, order_by = date))))) %>% 
  slice_max(order_by = date, n = 1) %>% 
  select(state, 
         "today_cases_7day_avg" = cases_7day_avg,
         delta_cases_WoW,
         "cumulative_cases" = cases,
         "today_deaths_7day_avg" = deaths_7day_avg,
         delta_deaths_WoW,
         "cumulative_deaths" = deaths) %>% 
  pivot_longer(!c(state,county), names_to = "view", values_to = "number")
  
gg <- ff %>% 
  left_join(county_pop_num, by = c("state", "county")) %>% 
  mutate(per_100K_number = case_when(view %in% c("delta_doses_WoW",
                                               "delta_cases_WoW",
                                               "delta_deaths_WoW") ~ number, 
                                     !(view %in% c("delta_doses_WoW",
                                               "delta_cases_WoW",
                                               "delta_deaths_WoW")) ~ number / pop * 100000)) %>% 
  select(-pop, -geometry)

gg$number <- round(gg$number, 2)
gg$per_100K_number <- round(gg$per_100K_number, 2)

hh <- gg %>% 
  mutate(slice1 = case_when(grepl("doses", view) ~ "vax",
                           grepl("cases", view) ~ "cases",
                           grepl("deaths", view) ~ "deaths",
                           grepl("hosp", view) ~ "hosp")) %>% 
  mutate(slice2 = case_when(grepl("today", view) ~ "today",
                            grepl("WoW", view) ~ "WoW",
                            grepl("cumulative", view) ~ "cumulative")) %>% 
  mutate(viz_number = comma(number),
         viz_per_100K_number = comma(per_100K_number)) %>% 
  separate(viz_number, c("viz_number"), "\\.") %>% 
  separate(viz_per_100K_number, c("viz_per_100K_number"), "\\.") %>% 
  mutate(viz_number = case_when(slice2 == "WoW" ~ paste(viz_number, "%", sep = ""),
                            slice2 != "WoW" ~ viz_number),
         viz_per_100K_number = case_when((slice2 == "WoW" ~ paste(viz_per_100K_number, "%", sep = "")),
                                          slice2 != "WoW" ~ viz_per_100K_number)) %>% 
  mutate(viz_number = case_when(slice2 == "WoW" & number > 0 ~ paste("+", viz_number, sep = ""),
                                slice2 != "WoW" | number <= 0 ~ viz_number),
         viz_per_100K_number = case_when(slice2 == "WoW" & per_100K_number > 0 ~ paste("+", viz_per_100K_number, sep = ""),
                                         slice2 != "Wow" | per_100K_number <= 0 ~ viz_per_100K_number))
```


```{r}
saveRDS(hh, file = paste("analysis_app/data_files/county_map_data", end_date, ".rds", sep = ""))

```

```{r}
saveRDS(county_pop, file = "analysis_app/data_files/county_geo_data.rds")
```

```{r}
county_pop
state_pop

both <- county_pop %>% 
  st_join(state_pop, by = "state")

both
```


```{r}

test <- hh %>% 
                filter(slice1 == "cases" & 
                           slice2 == "cumulative")
            
            mapping <- county_pop %>% right_join(test, by = c("state", "county"))
            
ggplot() + 
  # ,
  #                                                        text = paste(county, "<br>",
  #                                                                     state, "<br>",
  #                                                                     "Value:", viz_per_100K_number, "<br>"))) +
                 geom_sf(data = mapping, mapping = aes(fill = per_100K_number,
                                                         geometry = geometry, 
                                                       text = paste(county, "<br>",
                                                                       state, "<br>",
                                                                       "Value:", viz_per_100K_number, "<br>")), color = alpha("white", 1 / 2), size = 0.1) +
                geom_sf(data = state_pop, aes(geometry = state_geometry), fill = NA, color = "white") +
                theme_void() +
                theme2
            #    style2
```


```{r}
county_pop <- get_acs(geography = "county",
                  variables = c(pop = "B01003_001"), 
                  year = 2018,
                  geometry = TRUE, 
                  shift_geo = TRUE) %>% 
  clean_names() %>% 
   select(
     #geoid, 
          name, 
          "pop" = estimate,
          geometry) %>% 
  separate(col = name, c("county", "state"), sep = ", ") %>% 
  mutate(county = str_remove_all(county, " County")) %>% 
  mutate(county = str_remove_all(county, " Parish")) 
```




```{r}
vaccines %>% 
  summarize(totalpop = sum(pop),
            totaldoses = sum(total_doses_administered))
```
